<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gr치ficos de Barras</title>
</head>
<body>
  <h1>游늳 Gr치ficos de Barras</h1>
  <input type="date" id="data_filtro">
  <button onclick="rodarDBSCAN()">Rodar DBSCAN Geral</button>
  <button onclick="rodarDBSCANporData()">Rodar DBSCAN por Data</button>
  
  <a href="/">Voltar</a>

  <div id="saida"></div>

  <!-- Aqui as imagens estar칚o sempre vis칤veis -->
  <div id="imagens">
    <img id="barras_geral" style="max-width:90%">
    <img id="barras_data" style="max-width:90%">
  </div>

  <script>
    // Fun칞칚o para rodar o DBSCAN geral
    async function rodarDBSCAN() {
      const resp = await fetch("/rodar_dbscan");
      const json = await resp.json();
      document.getElementById("saida").innerText = json.saida || json.erro || "Conclu칤do.";
      atualizarGraficos();  // Atualiza ambas as imagens
    }

    // Fun칞칚o para rodar o DBSCAN por data
    async function rodarDBSCANporData() {
      const data_ref = document.getElementById("data_filtro").value;
      if (!data_ref) return alert("Escolha uma data!");
      const resp = await fetch("/rodar_dbscan_data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data_ref })
      });
      const json = await resp.json();
      document.getElementById("saida").innerText = json.saida || json.erro || "Conclu칤do";
      atualizarGraficos();  // Atualiza ambas as imagens
    }

    // Fun칞칚o para atualizar as imagens
    function atualizarGraficos() {
      // Atualiza a imagem de barras_geral
      const imgGeral = document.getElementById("barras_geral");
      imgGeral.src = "/grafico/barras_geral?rand=" + Math.random();  // For칞a a atualiza칞칚o
      imgGeral.style.display = "block";  // Garante que a imagem seja vis칤vel

      // Atualiza a imagem de barras_data
      const imgData = document.getElementById("barras_data");
      imgData.src = "/grafico/barras_data?rand=" + Math.random();  // For칞a a atualiza칞칚o
      imgData.style.display = "block";  // Garante que a imagem seja vis칤vel
    }

    // Fun칞칚o para verificar se as imagens precisam ser atualizadas
    function verificarNovosGraficos() {
      setInterval(async () => {
        try {
          // Verifica se os gr치ficos foram gerados
          const respGeral = await fetch("/grafico/barras_geral");
          const respData = await fetch("/grafico/barras_data");

          // Se ambos os gr치ficos est칚o dispon칤veis, atualiza as imagens
          if (respGeral.ok && respData.ok) {
            atualizarGraficos(); // Atualiza as imagens a cada 1 minuto
          }
        } catch (error) {
          console.error("Erro ao verificar novos gr치ficos:", error);
        }
      }, 60000);  // Checa a cada 60 segundos (1 minuto)
    }

    // Inicia o monitoramento dos gr치ficos assim que a p치gina carrega
    window.onload = () => {
      // Inicializa o monitoramento para os gr치ficos
      verificarNovosGraficos();

      // Faz a primeira atualiza칞칚o manualmente ao carregar a p치gina
      atualizarGraficos();
    };
  </script>
</body>
</html>
